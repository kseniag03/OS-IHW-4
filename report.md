#  ИДЗ №4 #
## Markdown report <br> ##

### 1. Ганина Ксения Андреевна 212 (тг для вопросов: @kgnn47) <br> ###
### 2. Вариант-21 <br> ###

![image](https://github.com/kseniag03/OS-IHW-4/blob/master/4-5/task_1.png)
![image](https://github.com/kseniag03/OS-IHW-4/blob/master/4-5/task_2.png)
________________________

### 3. Содержание отчёта <br> ###

#### 3.1. Нюансы <br> ####

Если запущен один клиент (или несколько клиентов с одинаковыми айди программиста), то сервер будет ожидать, пока не подключится ещё один программист с новым айди

В рамках задания корректное завершение реализовано частично (т.е. необходимо отключать оставшихся клиентов-программистов с помощью сигнала SIGINT). Завершение предусматривает закрытие сокета и удаление семафоров

При запуске програм требуемые для их работы IP адреса и порты задаются в командной строке для обеспечения гибкой подстройки к любой сети: можно задать разные айпи-адреса у программистов, и они смогут подключиться к серверу и отправлять ему запросы

В аргументах командной строки сервера можно записать число задач для выполнения. Число 1 не подходит, т.к. по условию должен происходить обмен между программистами. Также аргумент не может превышать определённую константу, чтобы правильно инициализировать массив задач. Константу в коде можно менять в блоке с define

При замене реализации с TCP на UDP были следующие изменения:
1) убраны connect() и accept(), т.к. протокол не требует подключения сокетов
2) при создании сокета указываем опции для протокола UDP:
```c
sock = socket(AF_INET, SOCK_DGRAM, IPPROTO_UDP);
```
3) разрешается широковещательная рассылка (broadcastPermission = 1):
```c
setsockopt(sock, SOL_SOCKET, SO_BROADCAST, (void *)&broadcastPermission, sizeof(broadcastPermission)
```
4) передача и приём данных осуществляются с помощью следущих ф-й:
```c
if (sendto(sock, &request, sizeof(struct request), 0, (struct sockaddr *)&servaddr, sizeof(servaddr)) != sizeof(request)) 
if (recvfrom(sock, &response, sizeof(struct response), 0, NULL, NULL) != sizeof(response))
```
5) изменения при передаче данных между клиентом и сервером (будут подробнее описаны в сценарии)

#### 3.2. Компиляция <br> ####

Сервер:
```sh
gcc common.c server.c -o 1
```
Клиент:
```sh
gcc common.c client.c -o 2
```

#### 3.3. Примеры запуска <br> ####

Сначала необходимо запустить сервер, а потом клиентов (иначе клиенты будут подключаться к другой сети, и сервер не дождётся ответа)

Сервер (число задач по умолчанию 10):
```sh
./1 5000
```
Сервер (число задач равно 5):
```sh
./1 5000 5
```

Для работы на нескольких компьютерах (при условии, что сервер запущен на 127.0.0.1):

Клиент-1:
```sh
./2 127.0.0.1 5000 1
```
Клиент-2:
```sh
./2 127.0.0.1 5000 2
```
Клиент-3:
```sh
./2 127.0.0.1 5000 3
```

Для работы в одной сети (локальной сети одного устройства):

Клиент-1:
```sh
./2 127.0.0.1 5000 1
```
Клиент-2:
```sh
./2 10.0.2.15 5000 2
```
Клиент-3:
```sh
./2 10.0.2.255 5000 3
```
________________________

### 4-5. сервер и все клиенты показывают видимое и порождаемое <br> ###

#### 4-5.1. Сценарий задачи <br> ####

1 сервер, 3 клиента -- по 1 на каждого программиста (коих по условию варианта всего 3). Запускать код клиента в терминале 3 раза с разными айди программистов. В целом, программа работает и с другим числов подключенных клиентов, но в случае 1 сервер рано или поздно придёт в состояние ожидания и не завершит работу, т.к. программист не может проверить выполненную им же работу

Аргументы командной строки сервера: исп. файл, порт сервера, число задач (по умолчанию равно MAX_TASK_COUNT = 10, define)

Аргументы командной строки клиента: исп. файл, номер программиста, ip сервера, порт сервера

На сервере хранится пулл задач, для каждой задачи устанавливаются флаги для понимания текущего процесса: новая (-1), выполняющаяся (0), выполненная (1), проверяющаяся (2), корректная (3), некорректная (4), на доработку(5)

Структура данных Задача содержит id (чтобы различать задачи между собой), id выполняющего (чтобы можно было 1) вывести информацию для наглядности 2) передать задачу в случае ошибок на исправление именно тому программисту, который эту задачу изначально выполнял), id проверяющего (для вывода и повторной проверки)

Система заканчивает работу, когда число выполненных задач будет равно числу всех задач, заявленных в командной строке (или в константах)

Взаимодействие сервера с клиентами происходит через обмен запросов-ответов -- создана структура со статусами (кодами) запросов/ответов, в которой, в отличии от реализации с TCP, не хранится значение задачи. Запрос (request) содержит номер запроса и айди программиста, ответ (response) содержит код ответа (ознакомиться с кодами и струкурами подробнее можно в [файле common.h](https://github.com/kseniag03/OS-IHW-4/blob/master/4-5/common.h))

Все действия над задачами перенесены на сервер. Т.к. убрана передача конкретной задачи из запроса в методы отправки решения задачи (sendTask) и отправки результата проверки задачи (sendCheckResult), пришлось добавить дополнительные массивы с задачами на выполнение и задачами на проверку. При отправке решения сервер вычисляет задачу по соот-му статусу (EXECUTING) и по айди текущего программиста. При проверке -- сервер по айди программиста находит задачи, в которых этот программист отмечен проверяющим, и для каждой вычисляет результат проверки через рандом

Добавлены sleep() для менее хаотичного вывода в консоль

При завершении сервера (по окончании работ или сигналом SIGINT) удалются семафоры и закрывается сокет сервера. Выводится лог итога

#### 4-5.2. Код с комментариями <br> ####

[Задание на 4-5 балла](https://github.com/kseniag03/OS-IHW-4/tree/master/4-5) <br>
[Задание на 4-5 балла, клиент](https://github.com/kseniag03/OS-IHW-4/blob/master/4-5/client.c) <br>
[Задание на 4-5 балла, сервер](https://github.com/kseniag03/OS-IHW-4/blob/master/4-5/server.c) <br>

#### 4-5.3. Тестовые прогоны <br> ####

![image](https://github.com/kseniag03/OS-IHW-4/blob/master/4-5/4-5_1_1.png)
![image](https://github.com/kseniag03/OS-IHW-4/blob/master/4-5/4-5_1_2.png)
![image](https://github.com/kseniag03/OS-IHW-4/blob/master/4-5/4-5_1_3.png)
![image](https://github.com/kseniag03/OS-IHW-4/blob/master/4-5/4-5_2_1.png)
![image](https://github.com/kseniag03/OS-IHW-4/blob/master/4-5/4-5_2_2.png)
